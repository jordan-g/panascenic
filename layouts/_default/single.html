{{ define "main" }}
<div class="container">
    <article class="photo-single">
        <div class="photo-wrapper">
            {{/* Find dark mode image first */}}
            {{ $darkImage := .Resources.GetMatch "image-dark.*" }}
            
            {{/* Find framed image (baked frame) */}}
            {{ $framedImage := .Resources.GetMatch "image-framed.*" }}
            
            {{/* Find main image - exclude dark mode, thumbnail, and framed */}}
            {{ $image := "" }}
            {{ range .Resources.ByType "image" }}
                {{ if and (not $image) (not (hasPrefix .Name "image-dark")) (not (hasPrefix .Name "thumbnail")) (not (hasPrefix .Name "image-framed")) }}
                    {{ $image = . }}
                {{ end }}
            {{ end }}
            
            {{ $imageSrc := "" }}
            {{ $darkImageSrc := "" }}
            
            {{/* Use framed image if available, otherwise use original */}}
            {{ if $framedImage }}
                {{ $imageSrc = $framedImage.RelPermalink }}
            {{ else if $image }}
                {{ $imageSrc = $image.RelPermalink }}
            {{ else if .Params.image }}
                {{ $imageSrc = .Params.image | relURL }}
            {{ end }}
            
            {{ if $darkImage }}
                {{ $darkImageSrc = $darkImage.RelPermalink }}
            {{ end }}
            
            {{ if $imageSrc }}
                <img src="{{ $imageSrc }}" alt="{{ .Title }}" class="photo-large"{{ if $darkImageSrc }} data-light-src="{{ $imageSrc }}" data-dark-src="{{ $darkImageSrc }}"{{ end }}>
            {{ end }}
        </div>
        
        <div class="photo-info">
            {{ if .Title }}
            <h1 class="photo-title">{{ .Title }}</h1>
            {{ end }}
            {{ if .Content }}
            <div class="photo-description">
                {{ .Content }}
            </div>
            {{ end }}
            {{ if or .Params.photoDate .Params.camera .Params.location }}
            <div class="photo-meta">
                {{ if .Params.photoDate }}
                <span class="photo-meta-item photo-date">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
                        <line x1="16" y1="2" x2="16" y2="6"></line>
                        <line x1="8" y1="2" x2="8" y2="6"></line>
                        <line x1="3" y1="10" x2="21" y2="10"></line>
                    </svg>
                    {{ dateFormat "January 2, 2006" .Params.photoDate }}
                </span>
                {{ end }}
                {{ if .Params.camera }}
                <span class="photo-meta-item photo-camera">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"></path>
                        <circle cx="12" cy="13" r="4"></circle>
                    </svg>
                    {{ .Params.camera }}
                </span>
                {{ end }}
                {{ if .Params.location }}
                <a href="https://www.openstreetmap.org/?mlat={{ .Params.location.lat }}&mlon={{ .Params.location.lng }}#map=15/{{ .Params.location.lat }}/{{ .Params.location.lng }}" target="_blank" rel="noopener" class="photo-meta-item photo-location">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path>
                        <circle cx="12" cy="10" r="3"></circle>
                    </svg>
                    {{ .Params.location.name }}
                </a>
                {{ end }}
            </div>
            {{ end }}
        </div>
        
        {{/* === Related Photos === */}}
        {{ $currentSlug := path.Base .File.Dir }}
        {{ $relatedSlugs := slice }}

        {{/* Find all albums containing this photo and collect other photo slugs */}}
        {{ range .Site.Data.albums.albums }}
            {{ $album := . }}
            {{ $inAlbum := false }}
            {{ range .photoSlugs }}
                {{ if eq . $currentSlug }}
                    {{ $inAlbum = true }}
                {{ end }}
            {{ end }}
            {{ if $inAlbum }}
                {{ range $album.photoSlugs }}
                    {{ if ne . $currentSlug }}
                        {{ $relatedSlugs = $relatedSlugs | append . }}
                    {{ end }}
                {{ end }}
            {{ end }}
        {{ end }}

        {{/* Deduplicate slugs (photo may appear in multiple albums) */}}
        {{ $relatedSlugs = $relatedSlugs | uniq }}

        {{ if gt (len $relatedSlugs) 0 }}
        <div class="related-photos">
            <h2 class="related-photos-title">Related Photos</h2>
            <div class="related-photos-row">
                {{ range $relatedSlugs }}
                    {{ $slug := . }}
                    {{ range where $.Site.RegularPages "Section" "photos" }}
                        {{ if eq (path.Base .File.Dir) $slug }}
                            {{ $photo := . }}
                            {{ $thumbnail := $photo.Resources.GetMatch "thumbnail.*" }}
                            {{ $framedImage := $photo.Resources.GetMatch "image-framed.*" }}
                            {{ $image := "" }}
                            {{ range $photo.Resources.ByType "image" }}
                                {{ if and (not $image) (not (hasPrefix .Name "image-dark")) (not (hasPrefix .Name "thumbnail")) (not (hasPrefix .Name "image-framed")) }}
                                    {{ $image = . }}
                                {{ end }}
                            {{ end }}
                            
                            {{ $thumbSrc := "" }}
                            {{ if $thumbnail }}
                                {{ $thumbSrc = $thumbnail.RelPermalink }}
                            {{ else if $framedImage }}
                                {{ $thumbSrc = $framedImage.RelPermalink }}
                            {{ else if $image }}
                                {{ $thumbSrc = $image.RelPermalink }}
                            {{ end }}
                            
                            {{ if $thumbSrc }}
                            <a href="{{ $photo.RelPermalink }}" class="related-photo-item">
                                <img src="{{ $thumbSrc }}" alt="{{ $photo.Title }}" class="related-photo-img" loading="lazy">
                            </a>
                            {{ end }}
                        {{ end }}
                    {{ end }}
                {{ end }}
            </div>
        </div>
        {{ end }}

        <div class="photo-navigation">
            <a href="{{ "/" | relURL }}" class="back-link">‚Üê Back to Gallery</a>
        </div>
    </article>
</div>

{{ with .Resources.GetMatch "image-dark.*" }}
<script>
// Dark mode image switching for single photo (uses site's data-theme attribute)
(function() {
    function isDarkMode() {
        return document.documentElement.getAttribute('data-theme') === 'dark';
    }
    
    function updateDarkModeImage() {
        const isDark = isDarkMode();
        const img = document.querySelector('.photo-large[data-dark-src]');
        if (!img) return;
        
        if (isDark) {
            img.src = img.dataset.darkSrc;
        } else {
            img.src = img.dataset.lightSrc;
        }
    }
    
    // Initial update
    updateDarkModeImage();
    
    // Watch for theme changes via MutationObserver
    const observer = new MutationObserver(function(mutations) {
        mutations.forEach(function(mutation) {
            if (mutation.attributeName === 'data-theme') {
                updateDarkModeImage();
            }
        });
    });
    observer.observe(document.documentElement, { attributes: true });
})();
</script>
{{ end }}
{{ end }}

